---
title: Эталонная архитектура Интернета вещей Azure
description: Рекомендуемая архитектура для приложений Интернета вещей в Azure, использующая компоненты платформы как услуги (PaaS)
titleSuffix: Azure Reference Architectures
author: MikeWasson
ms.date: 01/09/2019
ms.openlocfilehash: 5a4b104044f3e64ffdce98e3952201d397d41f33
ms.sourcegitcommit: c053e6edb429299a0ad9b327888d596c48859d4a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/20/2019
ms.locfileid: "58344586"
---
# <a name="azure-iot-reference-architecture"></a>Эталонная архитектура Интернета вещей Azure

В этой эталонной архитектуре показана рекомендуемая архитектура для приложений Интернета вещей в Azure, использующая компоненты платформы как услуги (PaaS).

![Схема архитектуры](./_images/iot.png)

Приложения Интернета вещей можно описать как **вещи** (устройства) для передачи данных, которые создают **аналитические сведения**. Эти сведения создают **действия** для улучшения компании или процессов. Например, модуль (вещь), отправляющий данные температуры. Эти данные используются для оценки правильности работы модуля (анализ). Аналитические сведения используются, чтобы упреждающе назначить приоритет расписания обслуживания для модуля (действие).

Эта эталонная архитектура использует компоненты Azure PaaS (платформа как услуга). Другие варианты создания решений Интернета вещей в Azure:

- [Azure IoT Central](/azure/iot-central/). IoT Central — это полностью управляемое решение SaaS (программное обеспечение как услуга). Оно абстрагирует технические решения и позволяет сосредоточиться исключительно на собственном. Однако вместе с простотой вы получаете меньше настраиваемых решений, чем в решении на основе PaaS.
- С помощью компонентов ОС, таких как стек SMACK (Spark, Mesos, Akka, Cassandra, Kafka), оно развертывается на виртуальные машины Azure. Такой подход обеспечивает больший контроль, но и более сложен.

На высшем уровне существует два способа обработки данных телеметрии: "горячий" и "холодный" путь. Разница связана с требованиями к задержке и доступу к данным.

- **"Горячий" путь** позволяет анализировать данные в режиме реального времени по мере их поступления. При применении этого способа данные телеметрии должны обрабатываться с очень низкой задержкой. "Горячий" путь обычно реализуется с помощью подсистемы потоковой обработки. Выходные данные могут инициировать оповещение или записываться в структурированный формат, который можно запросить с помощью средств аналитики.
- **"Холодный" путь** позволяет выполнить пакетную обработку в течение более длительных интервалов (ежечасно или ежедневно). "Холодный" путь обычно работает с большими объемами данных, однако результаты не требуются также своевременно, как в "горячем" пути. В "холодном" пути собираются необработанные данные телеметрии, а затем передаются в процесс пакетной обработки.

## <a name="architecture"></a>Архитектура

Архитектура состоит из следующих компонентов. Для некоторых приложений могут требоваться лишь некоторые из перечисленных здесь компонентов.

**Устройства Интернета вещей**. Устройства можно безопасно зарегистрировать в облаке и подключать к нему для отправки и получения данных. Некоторые устройства могут быть **пограничными устройствами**, выполняющими определенную обработку данных на самом устройстве или в полевом шлюзе. Мы рекомендуем использовать [Azure IoT Edge](/azure/iot-edge/) для обработки пограничных устройств.

**Облачный шлюз**. Облачный шлюз предоставляет центр облачных вычислений устройств для безопасного подключения к облаку и отправки данных. Он также предоставляет возможности управления устройствами, включая команды и контроль устройств. Для облачного шлюза мы рекомендуем использовать [Центр Интернета вещей](/azure/iot-hub/). Центр Интернета вещей — это размещенная облачная служба, которая принимает данные о событиях с устройств, действуя как брокер сообщений между устройствами и серверными службами. Центр Интернета вещей предоставляет безопасное подключение, получение данных событий, двусторонний обмен сообщениями и управление устройствами.

**Подготовка устройства**. При регистрации и подключении большого набора устройств мы рекомендуем использовать [Службу подготовки устройств к добавлению в Центр Интернета вещей](/azure/iot-dps/) (DPS). DPS позволяет назначать и регистрировать устройства в определенные конечные точки Центра Интернета вещей Azure в нужном масштабе.

**Потоковая обработка.** Потоковая передача анализирует большие потоки записей данных и оценивает правила для этих потоков. Для обработки потоков данных рекомендуем использовать [Azure Stream Analytics](/azure/stream-analytics/). Stream Analytics может выполнять сложный анализ в необходимом масштабе с помощью функций ограничения окна, агрегаций потока и внешних соединителей источников данных. Кроме того, вы можете использовать Apache Spark в [Azure Databricks](/azure/azure-databricks/).

Машинное обучение позволяет выполнять алгоритмы прогнозирования на основе архивных данных телеметрии, включая такие сценарии, как прогнозное обслуживание. Для машинного обучения рекомендуем использовать [службу "Машинное обучение Azure"](/azure/machine-learning/service/).

**Хранилище "горячего" пути** содержит данные, которые должны быть сразу же доступны на устройстве для создания отчетов и визуализации. В качестве хранилища "горячего" пути мы рекомендуем использовать [Cosmos DB](/azure/cosmos-db/introduction). Cosmos DB — это многомодельная глобально распределенная база данных.

**Хранилище "холодного" пути** содержит данные, которые хранятся долгосрочно и используются в пакетной обработке. В качестве хранилища "холодного" пути мы рекомендуем использовать [хранилище BLOB-объектов Azure](/azure/storage/blobs/storage-blobs-introduction). Данные можно заархивировать в хранилище BLOB-объектов на неопределенное время без лишних затрат. Такие данные легко доступны для пакетной обработки.

При **преобразовании данных** выполняются действия с потоком данных телеметрии или его объединение. Примеры включают преобразование протоколов, например, преобразование двоичных данных в JSON или объединение точек данных. Если данные необходимо преобразовать до поступления в Центр Интернета вещей, мы рекомендуем использовать [шлюз протокола](/azure/iot-hub/iot-hub-protocol-gateway) (не показано). В противном случае данные можно преобразовать после поступления в Центр Интернета вещей. В этом случае мы рекомендуем использовать [Функции Azure](/azure/azure-functions/). В службе "Функции" есть встроенная интеграция с Центром Интернета вещей, Cosmos DB и хранилищем BLOB-объектов.

При **интеграции бизнес-процессов** действия выполняются на основе аналитических сведений из данных устройства. Сюда входит хранение информационных сообщений, создание оповещений, отправка электронной почты или текстовых сообщений или интеграция с CRM. Для интеграции бизнес-процессов мы рекомендуем использовать [Azure Logic Apps](/azure/logic-apps/logic-apps-overview).

**Управление пользователями** позволяет настроить ограничение пользователей или групп для выполнения действий на устройствах, таких как обновление встроенного ПО. Оно также определяет возможности для пользователей в приложениях. Для аутентификации и авторизации пользователей мы рекомендуем использовать [Azure Active Directory](/azure/active-directory/).

## <a name="scalability-considerations"></a>Вопросы масштабируемости

Приложение Интернета вещей следует создавать как отдельную службу, которую можно масштабировать независимо от других. Учитывайте следующие моменты масштабируемости:

**Центр Интернета вещей**. Для Центра Интернета вещей необходимо учитывать следующие факторы масштабирования:

- максимальная [дневная квота](/azure/iot-hub/iot-hub-devguide-quotas-throttling) сообщений в Центре Интернета вещей;
- квота на число подключенных устройств в экземпляре Центра Интернета вещей;
- пропускная способность приема данных &mdash; насколько быстро Центр Интернета вещей может принимать сообщения;
- пропускная способность обработки &mdash; скорость обработки входящих сообщений.

Каждый центр Интернета вещей подготавливается с определенным количеством единиц для каждого конкретного уровня. Уровень и число единиц определяют максимальную дневную квоту сообщений, которые вы можете отправить в центр. Дополнительные сведения см. в разделе о квотах и регулировании Центра Интернета вещей. Вы можете увеличить масштаб, не прерывая имеющиеся операции.

**Stream Analytics**. Задания Stream Analytics лучше всего масштабируются, если они параллельны во всех точках конвейера Stream Analytics, от ввода данных до запроса и вывода данных. Полностью параллельные задания позволяют Stream Analytics разделить работу между несколькими вычислительными узлами. В противном случае Stream Analytics должен объединять данные потока в одном расположении. Дополнительные сведения см. в статье [Использование параллелизации запросов в Azure Stream Analytics](/azure/stream-analytics/stream-analytics-parallelization).

Центр Интернета вещей автоматически разбивает сообщения устройств на основе идентификатора устройства. Все сообщения с определенного устройства будут всегда доставляться в тот же раздел, однако в одном разделе всегда будут сообщения с нескольких устройств. Таким образом, единицей измерения параллелизации является идентификатор раздела.

**Функции**. При чтении из конечной точки Центров событий существует максимальное количество экземпляров для каждого раздела Центра событий. Максимальная скорость обработки определяется тем, как быстро один экземпляр функции может обрабатывать события из одного раздела. Функция должна обрабатывать сообщения в пакетах.

**Cosmos DB**. Чтобы расширить коллекцию Cosmos DB, создайте коллекцию с ключом раздела и включите его в каждый написанный вами документ. Дополнительные сведения см. в разделе [с рекомендациями по выбору ключа раздела](/azure/cosmos-db/partition-data#best-practices-when-choosing-a-partition-key).

- Если вы храните и обновляете один документ на каждом устройстве, идентификатор устройства будет хорошим ключом раздела. Операции записи равномерно распределяются между ключами. Размер каждой секции строго ограничен, так как для значения каждого ключа есть по одному документу.
- Если вы храните отдельный документ для каждого сообщения устройства, использование идентификатора устройства в качестве ключа раздела быстро приведет к превышению ограничения в 10 ГБ на раздел. Идентификатор сообщения в этом случае является более оптимальным ключом раздела. Обычно вы все равно включаете идентификатор устройства в документ для индексации и запросов.

## <a name="security-considerations"></a>Вопросы безопасности

### <a name="trustworthy-and-secure-communication"></a>Надежный и безопасный обмен данными

Все данные, поступающие с устройства и отправляющиеся на него, должны быть надежными. Если устройство не может поддерживать следующие возможности шифрования, оно должно быть ограничено локальными сетями и вся межсетевая связь должна проходить через полевой шлюз:

- Шифрование данных с помощью надежно защищенного, публично проанализированного и широко реализованного алгоритма шифрования с симметричным ключом.
- Цифровая подпись с помощью надежно защищенного, публично проанализированного и широко реализованного алгоритма шифрования с симметричным ключом.
- Поддержка TLS 1.2 для TCP или других путей обмена данными на основе потоковой передачи или DTLS 1.2 для путей обмена данными на основе датаграммы. Поддержка обработки сертификата X.509 является необязательной. Ее можно заменить более эффективным с точки зрения вычислений и сети режимом ключа с предварительным общим доступом для TLS, который можно реализовать с поддержкой алгоритмов AES и SHA-2.
- Обновляемое хранилище ключей и ключи для каждого устройства. Каждое устройство должно иметь уникальный материальный ключ или маркеры, которые идентифицируют его в системе. Устройствам следует безопасно хранить ключи (например, с помощью безопасного хранилища ключей). Устройство должно иметь возможность периодически обновлять ключи или маркеры или мгновенно в аварийных ситуациях, например при нарушении системы безопасности.
- Встроенное ПО и программное обеспечение приложения на устройстве должны позволять применение обновлений для исправления обнаруженных уязвимостей безопасности.

Тем не менее многие устройства слишком ограничены для поддержки таких требований. В этом случае следует использовать полевой шлюз. Безопасное подключение устройств к полевому шлюзу через локальную сеть и шлюз обеспечивает безопасный обмен данными с облаком.

### <a name="physical-tamper-proofing"></a>Проверка физического незаконного изменения данных

Чтобы обеспечить целостность системы безопасности и надежность системы, архитектура устройства должна включать функции, защищающие от попыток физической манипуляции.

Например: 

- Выберите микроконтроллеры, микропроцессоры или вспомогательное оборудование, которое предоставляет безопасное хранилище и использует криптографический материал ключа, такой как интеграция доверенного платформенного модуля (TPM).
- Безопасный загрузчик и безопасная загрузка программного обеспечения, привязанная в доверенном платформенном модуле.
- Используйте датчики, чтобы обнаружить попытки вторжения и манипуляции средой устройства путем оповещения и потенциального цифрового самоуничтожения устройства.

Дополнительные сведения о безопасности см. в статье [Архитектура безопасности Интернета вещей](/azure/iot-fundamentals/iot-security-architecture).

### <a name="monitoring-and-logging"></a>Мониторинг и ведение журнала

Системы мониторинга и ведения журнала используются для определения работоспособности устройства и устранения неполадок. Они помогают ответить на следующие вопросы по операциям:

- Есть ли в устройствах или системах ошибки?
- Правильно ли устройства или системы настроены?
- Создают ли устройства или системы точные данные?
- Соответствуют ли системы ожиданиям компании и клиентов?

Средства ведения журнала и мониторинга обычно состоят из следующих четырех компонентов:

- средства проверки производительности системы и визуализации временной шкалы для мониторинга системы и базового устранения неполадок;
- прием данных в буфере, что позволяет поместить в буфер данные журнала;
- постоянное хранилище для хранения данных журнала;
- возможности поиска и запросов для просмотра данных журнала, используемых при детальном устранении неполадок.

Системы мониторинга предоставляют аналитические сведения о работоспособности, безопасности, стабильности и производительности решения Интернета вещей. Эти системы также могут предоставлять более подробное представление, записывать изменения конфигурации компонентов и предоставлять извлеченные данные журнала, с помощью которых можно выявить потенциальные уязвимости системы безопасности, улучшить процесс управления инцидентами и помочь владельцу системы устранять неполадки. Комплексные решения для мониторинга включают возможность запрашивать информацию для определенных подсистем или выполнять статистическую обработку в нескольких подсистемах.

Разработку системы мониторинга следует начинать с определения работоспособных операций, соблюдения нормативных требований и требований к аудиту. Собранные метрики могут включать:

- физические устройства, пограничные устройства и компоненты инфраструктуры, сообщающие об изменениях конфигурации;
- приложения, сообщающие об изменениях конфигурации, журналах аудита безопасности, сведения о частоте запросов, времени отклика, частоте появления ошибок и статистику сборки мусора для управляемых языков;
- базы данных, постоянные хранилища, кэши, сообщающие о производительности запросов и записи, изменениях схемы, журналах аудита безопасности, блокировках и взаимоблокировках, производительности индекса, потреблении ЦП, памяти и диска;
- управляемые службы (IaaS, PaaS, SaaS и FaaS), которые сообщают о метриках работоспособности и изменениях конфигурации, влияющих на работоспособность и производительность зависимой системы.

Визуализация метрик мониторинга позволяет операторам получать оповещения о нестабильности системы и облегчает реагирование на инциденты.

### <a name="tracing-telemetry"></a>Трассировка данных телеметрии

Трассировка данных телеметрии позволяет оператору отслеживать перемещение фрагмента данных телеметрии по системе с момента его создания. Трассировка очень важна для отладки и устранения неполадок. В решениях Интернета вещей, которые используют Центр Интернета вещей и [пакеты SDK для устройств Центра Интернета вещей](/azure/iot-hub/iot-hub-devguide-sdks), датаграммы трассировки можно создавать в качестве сообщений из облака на устройство и включать в поток телеметрии.

### <a name="logging"></a>Ведение журналов

Системы ведения журнала являются неотъемлемой частью понимания действий, выполненных решением, произошедших сбоев и могут помочь в устранении этих сбоев. Вы можете проанализировать журналы, чтобы помочь понять и исправить ошибки, улучшить характеристики производительности, а также обеспечить соответствие действующим правилам и нормам.

Несмотря на то что ведение журнала обычным текстом меньше влияет на первоначальные затраты на разработку, компьютеру сложнее его анализировать и читать. Мы рекомендуем использовать структурированное ведение журнала, чтобы собранная информация была доступна для анализа компьютером и удобной для чтения. Структурированное ведение журнала добавляет ситуационный контекст и метаданные к информации журнала. При структурированном ведении журнала свойства привилегированы и отформатированы по парам "ключ — значение" или имеют предопределенную схему для улучшения возможностей поиска и запросов.

## <a name="next-steps"></a>Дополнительная информация

- Дополнительные сведения о рекомендуемой архитектуре и вариантах реализации см. в PDF-документе об [эталонной архитектуре Центра Интернета вещей Microsoft Azure](http://aka.ms/iotrefarchitecture).

- Подробную документацию по различным службам Интернета вещей Azure см. в статье [Принципы работы Azure IoT](/azure/iot-fundamentals/).

- Пример реализации решения для Интернета вещей можно найти в [GitHub](https://github.com/mspnp/iot-guidance).
